<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minesweeper Clone</title>
    <link rel="icon" type="image/png" href="/icon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/icon/favicon.svg" />
    <link rel="shortcut icon" href="/icon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="LotusRex" />
    <link rel="manifest" href="/icon/site.webmanifest" />
    <script defer src="https://cloud.umami.is/script.js"
        data-website-id="f60d79dd-7473-44c3-99dd-c68242dc95ea"></script>
    <script src="/script/umami-events.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/script/config.js"></script>
    <style>
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #gameBoard {
            display: grid;
            border: 5px solid #333;
            background-color: #ddd;
            /* Grid layout diatur oleh JS */
        }

        .cell {
            width: 30px;
            height: 30px;
            background-color: #1f1f1f;
            /* Sel tertutup */
            border: 1px solid #bcbcbc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            -webkit-user-select: none;
            transition: background-color 0.1s;
        }

        .cell:hover:not(.opened) {
            background-color: #b9b9b9;
        }

        .opened {
            background-color: #e9e9e9;
            border: 1px solid #ccc;
            cursor: default;
        }

        /* Warna Angka */
        .count-1 {
            color: blue;
        }

        .count-2 {
            color: green;
        }

        .count-3 {
            color: red;
        }

        .count-4 {
            color: darkblue;
        }

        .count-5 {
            color: darkred;
        }

        .count-6 {
            color: teal;
        }

        .count-7 {
            color: black;
        }

        .count-8 {
            color: gray;
        }

        .mine {
            background-color: #ff0000;
            color: white;
        }

        .flag {
            color: red;
            font-size: 1.2rem;
        }

        .game-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        #startScreen,
        #gameOverScreen {
            display: none;
        }

        .customization-box {
            max-width: 350px;
            width: 80%;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen game-container p-4">

    <h2 class="text-3xl font-extrabold text-gray-800 mb-4">Minesweeper Clone</h2>

    <div class="relative game-container">

        <div class="flex justify-between w-full max-w-sm mt-4 p-2">
            <div class="text-xl font-bold text-gray-700">
                Waktu: <span id="timeDisplay" class="text-indigo-600">0</span>s
            </div>
            <div class="text-xl font-bold text-gray-700">
                Ranjau Tersisa: <span id="mineCountDisplay" class="text-red-600">0</span>
            </div>
        </div>

        <div id="gameBoard" class="mt-4 shadow-xl">
        </div>

        <p class="text-sm text-gray-500 mt-4">Klik Kiri untuk membuka. Klik Kanan/Tahan untuk bendera ($\text{ðŸš©}$).</p>

        <div id="startScreen" class="game-overlay">
            <div class="customization-box text-center">
                <h3 class="text-3xl font-extrabold mb-4 text-green-700">PILIH KESULITAN</h3>

                <div class="text-left mb-4">
                    <label for="usernameInput" class="block text-sm font-medium text-gray-700">Username Anda</label>
                    <input type="text" id="usernameInput" value="PemainSaber" placeholder="Masukkan Nama"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-gray-800">
                </div>

                <div class="text-left mb-6">
                    <label for="difficultySelect" class="block text-sm font-medium text-gray-700">Kesulitan</label>
                    <select id="difficultySelect"
                        class="mt-1 block w-full p-2 border border-gray-300 rounded-md text-gray-800 bg-white">
                        <option value="beginner">Beginner (9x9, 10 Ranjau)</option>
                        <option value="intermediate">Intermediate (16x16, 40 Ranjau)</option>
                        <option value="expert">Expert (30x16, 99 Ranjau)</option>
                    </select>
                </div>

                <button id="startGameBtn"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-150">
                    Mulai Game
                </button>
            </div>
        </div>

        <div id="gameOverScreen" class="game-overlay">
            <div class="customization-box text-center">
                <h3 class="text-4xl font-extrabold mb-4 text-red-600">GAME OVER!</h3>
                <p class="text-xl mb-6 text-gray-700">Waktu Anda: <span id="finalTime"
                        class="font-extrabold text-red-600">0</span>s</p>
                <button id="restartBtn"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-150">
                    Main Lagi
                </button>
            </div>
        </div>
    </div>

    <div class="mt-10 p-6 bg-white rounded-xl shadow-lg w-full max-w-xl">
        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Top Skor Waktu Tercepat</h3>
        <div id="leaderboardList">
            <p class="text-gray-500">Pilih kesulitan untuk melihat Leaderboard.</p>
        </div>
    </div>

    <script>
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Konfigurasi Kesulitan ---
        const DIFFICULTIES = {
            beginner: { ROWS: 9, COLS: 9, MINES: 10 },
            intermediate: { ROWS: 16, COLS: 16, MINES: 40 },
            expert: { ROWS: 16, COLS: 30, MINES: 99 }
        };
        const GAME_OVER_DELAY = 3000;

        // --- DOM Elements ---
        const gameBoard = document.getElementById('gameBoard');
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const mineCountDisplay = document.getElementById('mineCountDisplay');
        const timeDisplay = document.getElementById('timeDisplay');
        const finalTimeDisplay = document.getElementById('finalTime');
        const usernameInput = document.getElementById('usernameInput');
        const difficultySelect = document.getElementById('difficultySelect');
        const leaderboardList = document.getElementById('leaderboardList');
        const startGameBtn = document.getElementById('startGameBtn');
        const restartBtn = document.getElementById('restartBtn');

        // --- Status Game ---
        let gameGrid = [];
        let config = {};
        let isGameOver = true;
        let isGameStarted = false;
        let timeElapsed = 0;
        let timerInterval;
        let minesLeft = 0;
        let tilesToClear = 0;
        let gameUsername = 'PemainSaber';
        let currentDifficulty = 'beginner';

        // --- Supabase Functions ---

        async function saveScore(username, difficulty, time) {
            if (!username || time === 0) return;

            const { error } = await supabase
                .from('PublicData')
                .insert([
                    {
                        type: `Minesweeper - ${difficulty}`,
                        username: username,
                        data: difficulty,
                        score: time
                    },
                ]);

            if (error) {
                console.error('Error saving score:', error);
            }
        }

        async function fetchLeaderboard(difficulty) {
            leaderboardList.innerHTML = `<p class="text-gray-500 text-center">Memuat skor ${difficulty}...</p>`;

            const { data, error } = await supabase
                .from('PublicData')
                .select('username, score')
                .eq('type', `Minesweeper - ${difficulty}`)
                .order('score', { ascending: true })
                .limit(5);

            if (error) {
                leaderboardList.innerHTML = `<p class="text-red-500 text-center">Gagal memuat skor: ${error.message.substring(0, 50)}...</p>`;
                return;
            }

            if (data.length === 0) {
                leaderboardList.innerHTML = '<p class="text-gray-500 text-center">Belum ada skor. Ayo buat rekor!</p>';
                return;
            }

            leaderboardList.innerHTML = '';
            const ul = document.createElement('ul');
            ul.className = 'space-y-2 text-left';

            data.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center text-sm font-medium border-b pb-1 last:border-b-0';

                const rank = index + 1;

                li.innerHTML = `
                    <span class="font-bold text-lg text-gray-700 w-6">${rank}.</span>
                    <span class="flex-1">${item.username}</span>
                    <span class="text-indigo-600 font-extrabold">${item.score}s</span>
                `;
                ul.appendChild(li);
            });
            leaderboardList.appendChild(ul);
        }

        // --- Game Logic Functions ---

        function initGame() {
            currentDifficulty = difficultySelect.value;
            config = DIFFICULTIES[currentDifficulty];

            isGameOver = false;
            isGameStarted = false;
            timeElapsed = 0;
            minesLeft = config.MINES;
            tilesToClear = config.ROWS * config.COLS - config.MINES;

            mineCountDisplay.textContent = minesLeft;
            timeDisplay.textContent = 0;

            clearInterval(timerInterval);
            gameGrid = [];
            gameBoard.innerHTML = '';
            gameBoard.style.gridTemplateColumns = `repeat(${config.COLS}, 30px)`;

            for (let r = 0; r < config.ROWS; r++) {
                gameGrid[r] = [];
                for (let c = 0; c < config.COLS; c++) {
                    gameGrid[r][c] = {
                        row: r,
                        col: c,
                        isMine: false,
                        isOpened: false,
                        isFlagged: false,
                        mineCount: 0,
                        element: createCellElement(r, c)
                    };
                    gameBoard.appendChild(gameGrid[r][c].element);
                }
            }
        }

        function createCellElement(r, c) {
            // (Kode createCellElement sama seperti sebelumnya)
            const cellEl = document.createElement('div');
            cellEl.className = 'cell';
            cellEl.dataset.row = r;
            cellEl.dataset.col = c;

            cellEl.addEventListener('click', () => handleCellClick(r, c));

            cellEl.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                handleFlag(r, c);
            });

            let touchTimer;
            cellEl.addEventListener('touchstart', (e) => {
                if (isGameOver) return;
                touchTimer = setTimeout(() => {
                    handleFlag(r, c);
                }, 500);
            }, false);

            cellEl.addEventListener('touchend', (e) => {
                clearTimeout(touchTimer);
                if (isGameOver) return;
                if (e.changedTouches[0].target === cellEl && timeElapsed < 500) {
                    handleCellClick(r, c);
                }
            }, false);

            return cellEl;
        }

        function placeMines(startRow, startCol) {
            let minesPlaced = 0;
            const totalCells = config.ROWS * config.COLS;

            while (minesPlaced < config.MINES) {
                const randIndex = Math.floor(Math.random() * totalCells);
                const r = Math.floor(randIndex / config.COLS);
                const c = randIndex % config.COLS;

                const cell = gameGrid[r][c];

                if (!cell.isMine && (Math.abs(r - startRow) > 1 || Math.abs(c - startCol) > 1)) {
                    cell.isMine = true;
                    minesPlaced++;
                }
            }
            calculateMineCounts();
        }

        function calculateMineCounts() {
            // (Kode calculateMineCounts sama seperti sebelumnya)
            for (let r = 0; r < config.ROWS; r++) {
                for (let c = 0; c < config.COLS; c++) {
                    const cell = gameGrid[r][c];
                    if (cell.isMine) continue;

                    let count = 0;
                    getNeighbors(r, c).forEach(neighbor => {
                        if (neighbor.isMine) count++;
                    });
                    cell.mineCount = count;
                }
            }
        }

        function getNeighbors(r, c) {
            // (Kode getNeighbors sama seperti sebelumnya)
            const neighbors = [];
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    if (dr === 0 && dc === 0) continue;
                    const nr = r + dr;
                    const nc = c + dc;

                    if (nr >= 0 && nr < config.ROWS && nc >= 0 && nc < config.COLS) {
                        neighbors.push(gameGrid[nr][nc]);
                    }
                }
            }
            return neighbors;
        }

        // --- Handler Aksi Pemain ---

        function handleCellClick(r, c) {
            if (isGameOver) return;
            const cell = gameGrid[r][c];

            if (!isGameStarted) {
                placeMines(r, c);
                isGameStarted = true;
                timerInterval = setInterval(() => {
                    timeElapsed++;
                    timeDisplay.textContent = timeElapsed;
                }, 1000);
                openCell(r, c);
                return;
            }

            if (cell.isOpened || cell.isFlagged) return;

            if (cell.isMine) {
                // Hentikan timer dan tunjukkan bom yang diledakkan
                clearInterval(timerInterval);
                cell.element.textContent = 'ðŸ’£';
                cell.element.classList.add('mine');

                // --- JEDA DAN REVEAL ---
                revealAllMines();
                setTimeout(() => {
                    endGame(false);
                }, GAME_OVER_DELAY);

                return;
            }

            openCell(r, c);
            checkWin();
        }

        function handleFlag(r, c) {
            if (isGameOver || gameGrid[r][c].isOpened) return;
            const cell = gameGrid[r][c];

            if (cell.isFlagged) {
                cell.isFlagged = false;
                cell.element.textContent = '';
                minesLeft++;
            } else if (minesLeft > 0) {
                cell.isFlagged = true;
                cell.element.textContent = 'ðŸš©';
                minesLeft--;
            }
            mineCountDisplay.textContent = minesLeft;
        }

        // --- Rekursif Opening ---

        function openCell(r, c) {
            // (Kode openCell sama seperti sebelumnya)
            const cell = gameGrid[r][c];

            if (cell.isOpened || cell.isFlagged || cell.isMine) return;

            cell.isOpened = true;
            cell.element.className = 'cell opened';
            tilesToClear--;

            if (cell.mineCount > 0) {
                cell.element.textContent = cell.mineCount;
                cell.element.classList.add(`count-${cell.mineCount}`);
                return;
            }

            getNeighbors(r, c).forEach(neighbor => {
                if (!neighbor.isOpened) {
                    openCell(neighbor.row, neighbor.col);
                }
            });
        }

        // --- Flow Game ---

        function checkWin() {
            if (tilesToClear === 0) {
                endGame(true);
            }
        }

        function revealAllMines() {
            // Tampilkan semua ranjau, kecuali yang sudah ditandai dengan bendera
            for (let r = 0; r < config.ROWS; r++) {
                for (let c = 0; c < config.COLS; c++) {
                    const cell = gameGrid[r][c];
                    if (cell.isMine && !cell.element.classList.contains('mine')) { // Jangan ubah ranjau yang sudah diledakkan
                        cell.element.className = 'cell opened mine-revealed';
                        cell.element.textContent = 'ðŸ’£';
                    } else if (cell.isFlagged && !cell.isMine) {
                        // Tunjukkan bendera yang salah
                        cell.element.textContent = 'âŒ';
                        cell.element.style.backgroundColor = 'yellow';
                    }
                }
            }
        }

        function endGame(won) {
            isGameOver = true;
            clearInterval(timerInterval);

            finalTimeDisplay.textContent = timeElapsed;
            const h3 = document.querySelector('#gameOverScreen h3');

            if (won) {
                h3.textContent = 'SELAMAT, ANDA MENANG!';
                h3.classList.replace('text-red-600', 'text-green-600');
                saveScore(gameUsername, currentDifficulty, timeElapsed);
            } else {
                h3.textContent = 'GAME OVER!';
                h3.classList.replace('text-green-600', 'text-red-600');
            }

            gameOverScreen.style.display = 'flex';

            setTimeout(() => fetchLeaderboard(currentDifficulty), 1000);
        }

        // --- Inisialisasi ---

        function setupGame() {
            gameUsername = usernameInput.value.trim() || 'PemainSaber';
            if (gameUsername.length > 20) gameUsername = gameUsername.substring(0, 20);

            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';

            initGame();
        }

        startGameBtn.addEventListener('click', setupGame);
        restartBtn.addEventListener('click', setupGame);

        difficultySelect.addEventListener('change', (e) => {
            fetchLeaderboard(e.target.value);
        });

        document.addEventListener('DOMContentLoaded', () => {
            startScreen.style.display = 'flex';
            fetchLeaderboard(difficultySelect.value);
        });
    </script>
</body>

</html>